# 3.4 データフレーム

> **本節の目標**
> 
> 表形式でデータを管理するコレクション「**データフレーム**」の使い方を学びます。
> データフレームは、データサイエンスで最も頻繁に使うデータ構造です。
> 
> | name | english | math | gender |
> | :--- | :--- | :--- | :--- |
> | A | 60 | 70 | f |
> | B | 90 | 80 | m |
> | C | 70 | 90 | m |
> | D | 90 | 100 | f |

---

## 3.4.0 データフレームとは

### 📊 データフレームの概念

データフレームは、**表形式のデータ**を扱うための便利なデータ構造です。Excelのスプレッドシートや、データベースのテーブルのように、行と列で構成されています。

データサイエンスでは、データを整理して分析するために、このデータフレームを頻繁に使います。例えば、

- 学生の成績データ（名前、各科目の点数、性別など）
- 気象データ（日付、最高気温、最低気温、降水量など）
- 売上データ（商品名、価格、販売数、売上日など）

これらすべてのデータを、データフレームとして扱うことができます。

### 📚 データフレームに関する専門用語

データフレームを扱う際に使われる専門用語を理解しておきましょう。以下の表は、本節の目標に掲載した学生成績データ（`my_df`）を例にした用語の説明です。

| 用語 | 説明 | 例 |
| :--- | :--- | :--- |
| **サンプル (sample)** | データフレームの全体。標本、データセットともいう | `my_df`全体（4行4列の表） |
| **サンプルサイズ (sample size)** | データフレームの行数。「標本の大きさ」ともいう | `my_df`のサンプルサイズは**4**（A, B, C, Dの4行） |
| **インスタンス (instance)** | データフレームの1行。レコード（record）ともいう | 最初のインスタンスは「A, 60, 70, f」 |
| **変数 (variable)** | データフレームの列。特徴（feature）、属性（attribute）ともいう | 変数`english`は「60, 90, 70, 90」 |
| **観測値 (observed value)** | 特定のインスタンスの変数の値 | Aの`english`の観測値は「60」 |

#### ⚠️ よくある用語の誤用に注意

データサイエンスでは、用語を正確に使うことが重要です。特に以下の点に注意してください：

1. **「サンプル数」は使わない**
   - ❌ 「サンプル数が4」
   - ✅ 「サンプルサイズが4」
   - 理由：「サンプル数が4」では、データセットが4つあることになってしまいます

2. **「母数」は統計学の別の概念**
   - ❌ 「母数が4」（サンプルサイズの意味で）
   - ✅ 「サンプルサイズが4」
   - 理由：母数（parameter）は確率分布を特定するための定数のことです

3. **「行」と「列」の明確な区別**
   - 行（row）= 横方向の並び = インスタンス
   - 列（column）= 縦方向の並び = 変数

### 🛠️ 環境の準備

データフレームを使うには、専用のライブラリを読み込む必要があります。本節では、最後までこの設定が有効であることを前提とします。

**ターミナルで以下を実行してください：**

#### Rの場合

まず、Rのインタラクティブモードを起動します。

```bash
$ R
```

Rが起動したら、以下を実行してライブラリを読み込みます。

```r
> library(tidyverse)
```

実行後、Rを終了します。

```r
> q()
```

保存確認が出たら、`n`（保存しない）を選択してください。

#### Pythonの場合

Pythonのインタラクティブモードを起動します。

```bash
(class) $ python
```

Pythonが起動したら、以下を実行してライブラリを読み込みます。

```python
>>> import pandas as pd
```

実行後、Pythonを終了します。

```python
>>> exit()
```

#### 💡 ライブラリについて

- **R**: `tidyverse`は、データ操作を便利にする関数群をまとめたパッケージです
- **Python**: `pandas`は、データフレーム操作のための標準的なライブラリです

これらのライブラリを読み込むことで、データフレームを簡単に扱えるようになります。

> 📝 **重要**: プログラムファイル（`.py`や`.R`）を作成する場合も、ファイルの先頭で必ずこのライブラリを読み込んでください。

---

## 3.4.1 データフレームの作成

データフレームを作成する方法を学びましょう。ここでは、学生の成績データを例として使います。

作成するデータ：

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| B | 90 | 80 | m |
| C | 70 | 90 | m |
| D | 90 | 100 | f |

### 3.4.1.1 列ごとにデータを記述する方法

データを**列ごとに**記述してデータフレームを作成する方法です。これは最も基本的な方法で、各列（変数）のデータをまとめて指定します。

#### 📝 sample01_create_column.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームの作成（列ごとに記述）
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# データフレームの表示
print(my_df)
```

**実行方法：**

```bash
(class) $ python sample01_create_column.py
```

**期待される出力：**

```
  name  english  math gender
0    A       60    70      f
1    B       90    80      m
2    C       70    90      m
3    D       90   100      f
```

#### 📝 sample01_create_column.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームの作成（列ごとに記述）
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# データフレームの表示
print(my_df)
```

**実行方法：**

```bash
$ Rscript sample01_create_column.R
```

**期待される出力：**

```
  name english math gender
1    A      60   70      f
2    B      90   80      m
3    C      70   90      m
4    D      90  100      f
```

#### 🔍 コードの解説

**Python版：**
- `pd.DataFrame({...})`: 辞書形式でデータフレームを作成
- キー（`'name'`, `'english'`など）が列名になります
- 値（リスト）がその列のデータになります

**R版：**
- `data.frame(...)`: 列名とデータのペアを指定
- `c(...)`でベクタ（1次元データ）を作成
- 各列のデータ長は同じでなければなりません

#### 💭 この方法の特徴

**利点：**
- 列の意味（変数名）が明確
- 各列のデータ型を意識しやすい
- データの構造が理解しやすい

**適している場面：**
- 列数が少ない場合
- 各列のデータ型が異なる場合
- プログラムで列単位のデータを扱う場合

---

### 3.4.1.2 行ごとにデータを記述する方法

データを**行ごとに**記述してデータフレームを作成する方法です。表の見た目のとおりに入力できるので、直感的でわかりやすい方法です。

#### 📝 sample02_create_row.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームの作成（行ごとに記述）
my_df = pd.DataFrame([
    ['A', 60, 70, 'f'],
    ['B', 90, 80, 'm'],
    ['C', 70, 90, 'm'],
    ['D', 90, 100, 'f']
], columns=['name', 'english', 'math', 'gender'])

# データフレームの表示
print(my_df)
```

**実行方法：**

```bash
(class) $ python sample02_create_row.py
```

**期待される出力：**

```
  name  english  math gender
0    A       60    70      f
1    B       90    80      m
2    C       70    90      m
3    D       90   100      f
```

#### 📝 sample02_create_row.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームの作成（行ごとに記述）
my_df <- tribble(
  ~name, ~english, ~math, ~gender,
    "A",       60,    70,     "f",
    "B",       90,    80,     "m",
    "C",       70,    90,     "m",
    "D",       90,   100,     "f"
)

# データフレームの表示
print(my_df)
```

**実行方法：**

```bash
$ Rscript sample02_create_row.R
```

**期待される出力：**

```
# A tibble: 4 × 4
  name  english  math gender
  <chr>   <dbl> <dbl> <chr> 
1 A          60    70 f     
2 B          90    80 m     
3 C          70    90 m     
4 D          90   100 f     
```

#### 🔍 コードの解説

**Python版：**
- リストのリスト形式でデータを作成
- `columns=[...]`で列名を別途指定
- 行の順番でデータを記述できる

**R版：**
- `tribble()`関数を使用（tidyverseの機能）
- `~`（チルダ）で列名を指定
- 見た目が表に近いので入力しやすい

> 📝 **補足**: Rでは、`data.frame()`と`tribble()`で作成されるデータフレームの型が少し異なりますが、本書では特に区別せず使用します。

#### 💭 この方法の特徴

**利点：**
- 見た目が表に近く、直感的
- 行単位でデータを確認しやすい
- 手入力する場合に便利

**適している場面：**
- 行数が少ない場合
- データを手入力する場合
- 表の構造をそのまま表現したい場合

---

### 3.4.1.3 データフレームのサイズ確認

作成したデータフレームのサイズ（行数と列数）を確認する方法を学びましょう。

#### 📝 sample03_dataframe_size.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームの作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 行数と列数を取得
rows, cols = my_df.shape
print(f"行数と列数: ({rows}, {cols})")

# 行数のみ
print(f"行数: {rows}")
# あるいは len(my_df) でも可

# 列数のみ
print(f"列数: {cols}")
```

**実行方法：**

```bash
(class) $ python sample03_dataframe_size.py
```

**期待される出力：**

```
行数と列数: (4, 4)
行数: 4
列数: 4
```

#### 📝 sample03_dataframe_size.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームの作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 行数と列数を取得
result <- dim(my_df)
print(paste("行数と列数:", result[1], result[2]))

# 行数のみ
print(paste("行数:", nrow(my_df)))

# 列数のみ
print(paste("列数:", ncol(my_df)))
```

**実行方法：**

```bash
$ Rscript sample03_dataframe_size.R
```

**期待される出力：**

```
[1] "行数と列数: 4 4"
[1] "行数: 4"
[1] "列数: 4"
```

#### 🔍 コードの解説

**Python版：**
- `.shape`: データフレームのサイズを (行数, 列数) のタプルで返す
- `rows, cols = my_df.shape`: タプルをアンパック（分解）して変数に代入
- `len(my_df)`: 行数を取得する別の方法

**R版：**
- `dim()`: 行数と列数をベクタで返す
- `nrow()`: 行数のみを取得
- `ncol()`: 列数のみを取得

#### 💡 サイズ確認が重要な理由

データフレームのサイズを確認することは、以下の場面で重要です。

1. **データ読み込み後の確認**
   - ファイルから読み込んだデータが正しいか確認

2. **データ処理の途中確認**
   - フィルタリング後に何行残っているか確認

3. **エラーの原因特定**
   - 期待する行数・列数になっているか確認

---

### 3.4.1.4 組合せデータの生成

複数の要素のすべての組合せを持つデータフレームを作成する方法を学びましょう。

#### 例：X と Y のすべての組合せ

- X: 1, 2, 3 のいずれか
- Y: 10, 100 のいずれか

この場合、組合せは (1,10), (1,100), (2,10), (2,100), (3,10), (3,100) の6通りです。

#### 📝 sample04_combination.py

```python
# 必要なライブラリを読み込む
import pandas as pd
from itertools import product

# XとYのすべての組合せを作成
my_df = pd.DataFrame(
    product([1, 2, 3], [10, 100]),
    columns=['X', 'Y']
)

# 結果を表示
print(my_df)
```

**実行方法：**

```bash
(class) $ python sample04_combination.py
```

**期待される出力：**

```
   X    Y
0  1   10
1  1  100
2  2   10
3  2  100
4  3   10
5  3  100
```

#### 📝 sample04_combination.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# XとYのすべての組合せを作成
my_df <- expand.grid(
  X = c(1, 2, 3),
  Y = c(10, 100)
)

# 結果を表示
print(my_df)
```

**実行方法：**

```bash
$ Rscript sample04_combination.R
```

**期待される出力：**

```
  X   Y
1 1  10
2 2  10
3 3  10
4 1 100
5 2 100
6 3 100
```

#### 🔍 コードの解説

**Python版：**
- `itertools.product()`: 複数のリストの直積（すべての組合せ）を生成
- 結果はイテレータなので、`pd.DataFrame()`に渡してデータフレームに変換
- `columns`で列名を指定

**R版：**
- `expand.grid()`: すべての組合せを持つデータフレームを直接生成
- 各引数に列名とデータを指定

#### ⚠️ 注意：組合せの順序が異なる

PythonとRで、生成される組合せの順序が異なることに注意してください：

- **Python**: 最後の要素が最初に変化（1,10 → 1,100 → 2,10 ...）
- **R**: 最初の要素が最初に変化（1,10 → 2,10 → 3,10 ...）

順序が重要な場合は、後で並べ替え（3.4.3.6項）を行います。

#### 💡 組合せデータの用途

組合せデータは、以下のような場面で使われます。

- **パラメータの網羅的なテスト**: すべてのパラメータの組合せで実験
- **グリッドサーチ**: 機械学習のハイパーパラメータ最適化
- **シミュレーション**: 複数の条件の組合せでシミュレーション

---

### 3.4.1.5 列と行の名前の操作

データフレームの列名（カラム名）と行名（インデックス）を取得・変更する方法を学びましょう。

#### 📝 sample05_column_row_names.py

```python
# pandasライブラリを読み込む
import pandas as pd

# サンプルデータフレームの作成
my_df = pd.DataFrame({
    'X': [1, 1, 2, 2, 3, 3],
    'Y': [10, 100, 10, 100, 10, 100]
})

# 列名の取得
print("列名:")
print(my_df.columns.tolist())

# 列名の変更
my_df.columns = ['P', 'Q']
print("\n列名変更後:")
print(my_df)

# 行名の取得（デフォルトは0から始まる番号）
print("\n行名:")
print(list(my_df.index))

# 行名の変更
my_df.index = ['a', 'b', 'c', 'd', 'e', 'f']
print("\n行名変更後:")
print(my_df)
```

**実行方法：**

```bash
(class) $ python sample05_column_row_names.py
```

**期待される出力：**

```
列名:
['X', 'Y']

列名変更後:
   P    Q
0  1   10
1  1  100
2  2   10
3  2  100
4  3   10
5  3  100

行名:
[0, 1, 2, 3, 4, 5]

行名変更後:
   P    Q
a  1   10
b  1  100
c  2   10
d  2  100
e  3   10
f  3  100
```

#### 📝 sample05_column_row_names.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# サンプルデータフレームの作成
my_df <- data.frame(
  X = c(1, 1, 2, 2, 3, 3),
  Y = c(10, 100, 10, 100, 10, 100)
)

# 列名の取得
print("列名:")
print(colnames(my_df))

# 列名の変更
colnames(my_df) <- c("P", "Q")
print("列名変更後:")
print(my_df)

# 行名の取得（デフォルトは1から始まる番号）
print("行名:")
print(row.names(my_df))

# 行名の変更
row.names(my_df) <- c("a", "b", "c", "d", "e", "f")
print("行名変更後:")
print(my_df)
```

**実行方法：**

```bash
$ Rscript sample05_column_row_names.R
```

**期待される出力：**

```
[1] "列名:"
[1] "X" "Y"
[1] "列名変更後:"
  P   Q
1 1  10
2 1 100
3 2  10
4 2 100
5 3  10
6 3 100
[1] "行名:"
[1] "1" "2" "3" "4" "5" "6"
[1] "行名変更後:"
  P   Q
a 1  10
b 1 100
c 2  10
d 2 100
e 3  10
f 3 100
```

#### 🔍 コードの解説

**Python版：**
- `.columns`: 列名を取得・設定
- `.index`: 行名（インデックス）を取得・設定
- デフォルトの行名は0から始まる整数

**R版：**
- `colnames()`: 列名を取得・設定
- `row.names()`: 行名を取得・設定
- デフォルトの行名は1から始まる整数

#### ⚠️ PythonとRの重要な違い

**行番号の開始位置：**
- **Python**: 0から始まる（0, 1, 2, 3, ...）
- **R**: 1から始まる（1, 2, 3, 4, ...）

この違いは、データを取り出す際にも影響します（3.4.3項）。

#### 💡 列名・行名の使い方

**列名の用途：**
- データの意味を明確にする
- プログラムでの列指定に使用
- 可視化の際のラベルに使用

**行名の用途：**
- 各行を識別しやすくする
- 可視化の際のラベルに使用
- データの結合時のキーとして使用

---

## 💡 GitHub Copilot活用ガイド（3.4.1 データフレームの作成）

### このセクションで学んだことをCopilotで実践

データフレームの作成は、データサイエンスの最初のステップです。ここまでで、列ごと・行ごとの作成方法、サイズ確認、組合せデータ、列名・行名の操作を学びました。これらの操作は頻繁に使うので、Copilotを活用して素早く正確に書けるようになりましょう。

Copilotは、あなたが書こうとしているデータフレーム操作を予測してコードを提案してくれます。コメントを書くだけでコードが生成されることもあります！

---

### 🚀 使えるプロンプト例

#### プロンプト例1: 商品データのデータフレーム作成 [★☆☆]

**Copilot Chatに入力**:
```
Pythonで、以下の商品データのデータフレームを作成してください：
- 商品名: りんご、バナナ、オレンジ
- 価格: 100, 80, 120
- 在庫: 50, 30, 20
列ごとにデータを記述する方法で、pandasを使用してください。
```

**期待される動作**:
- `pd.DataFrame()`を使った列指定形式のコードが生成される
- 列名が日本語で適切に設定される
- シンプルで初心者にも理解しやすいコード

**やってみよう**:
1. VS Codeで新しいPythonファイル `copilot_practice01.py` を作成
2. Copilot Chatを開いて上記プロンプトを入力
3. 生成されたコードを確認し、理解してからファイルに貼り付け
4. 実行して正しく動作するか確認

---

#### プロンプト例2: 行ごとの記述でデータフレーム作成 [★☆☆]

**Copilot Chatに入力**:
```
Rで、学生の試験結果データフレームを作成してください：
名前: 田中、佐藤、鈴木
国語: 85, 90, 78
数学: 92, 88, 95
tribbleを使って行ごとに記述する方法でお願いします。
```

**期待される動作**:
- `tribble()`を使ったコードが生成される
- チルダ（~）で列名が指定される
- 見た目が表に近い読みやすいコード

**やってみよう**:
1. VS Codeで新しいRファイル `copilot_practice01.R` を作成
2. Copilot Chatで上記プロンプトを入力
3. 生成されたコードを確認
4. 実行して結果を確認

---

#### プロンプト例3: 組合せデータの生成 [★★☆]

**Copilot Chatに入力**:
```
Pythonで、機械学習のハイパーパラメータ探索用のデータフレームを作成してください。
以下のパラメータのすべての組合せを作りたいです。
- learning_rate: 0.001, 0.01, 0.1
- batch_size: 16, 32, 64
itertoolsのproductを使用してください。
```

**期待される動作**:
- `itertools.product()`を使ったコードが生成される
- 適切な列名が設定される
- すべての組合せ（9通り）が生成される

**やってみよう**:
1. 新しいファイル `copilot_practice02.py` を作成
2. プロンプトを入力してコードを生成
3. 実行して9行のデータフレームができることを確認
4. 別の組合せ（例: [2, 3, 4] と [True, False]）で試してみる

---

#### プロンプト例4: 列名と行名の設定 [★★☆]

**Copilot Chatに入力**:
```
Pythonで、以下の要件を満たすデータフレームを作成してください：
1. 3行2列のデータフレーム
2. 列名は "temperature" と "humidity"
3. 行名は "Tokyo", "Osaka", "Fukuoka"
4. データは適当な数値で構いません
作成時に列名と行名を同時に設定する方法でお願いします。
```

**期待される動作**:
- `pd.DataFrame()`で`columns`と`index`を同時に指定
- データ、列名、行名が一度に設定される
- 実用的なコード例

**やってみよう**:
1. 新しいファイル `copilot_practice03.py` を作成
2. プロンプトを入力してコードを生成
3. 実行して列名・行名が正しく設定されているか確認
4. 自分で別の列名・行名に変更してみる

---

#### プロンプト例5: サイズ確認と情報表示 [★★★]

**Copilot Chatに入力**:
```
Pythonで、データフレームの詳細情報を表示する関数を作ってください。
以下の情報を見やすく表示してください：
- 行数と列数
- 列名のリスト
- 各列のデータ型
- 最初の3行
関数名は show_dataframe_info としてください。
```

**期待される動作**:
- 関数が定義される
- `.shape`, `.columns`, `.dtypes`, `.head()` などを使用
- 見やすい形式で情報が表示される

**やってみよう**:
1. 新しいファイル `copilot_practice04.py` を作成
2. プロンプトを入力して関数を生成
3. サンプルデータフレームで関数をテスト
4. 自分で他の情報（例: メモリ使用量）も表示するように拡張

---

### 📚 Copilot活用のコツ

#### 1. **コメントを先に書く**

Copilotは、コメントからコードを生成するのが得意です。例えば、

```python
# 商品データのデータフレームを作成
# 列: name, price, stock
```

とコメントを書いてから改行すると、Copilotがコードを提案してくれます。

**実験してみよう**:
- 日本語コメントと英語コメントで違いがあるか試す
- 詳しいコメントと簡潔なコメントで提案が変わるか確認

#### 2. **段階的に書く**

一度に全部書こうとせず、段階的にコードを書きましょう。

```python
# 1. まずライブラリを読み込む
import pandas as pd

# 2. データフレームを作成
# (ここでCopilotが提案)

# 3. サイズを確認
# (ここでCopilotが提案)
```

#### 3. **生成されたコードを必ず理解する**

Copilotが生成したコードは、必ず自分で読んで理解してください：

- 各行が何をしているか確認
- わからない関数やメソッドがあれば調べる
- なぜそのように書いているのか考える

**理解を深める質問例**:
- 「このコードの各行の意味を説明してください」
- 「なぜ list() で囲む必要があるのですか？」
- 「他の書き方はありますか？」

#### 4. **実験する**

生成されたコードを実行したら、以下を試してみましょう。

- データを変更してみる（行数、列数、データ型など）
- 存在しない列名にアクセスするとどうなる？
- 行数と列数が合わないデータを与えるとどうなる？

エラーを経験することも重要な学習です！

---

### ⚠️ 注意事項

#### **AIは完璧ではない**
Copilotが生成するコードが常に正しいとは限りません。
- 構文エラーがある場合もある
- 非効率なコードの場合もある
- 期待と違う動作をする場合もある

**対処法**: 必ず実行して動作を確認し、エラーがあれば自分で修正する経験を積む

#### **理解が第一**
Copilotに頼りすぎて、自分で考えなくなることを避けましょう。
- まず自分で考えてコードを書いてみる
- 詰まったらCopilotに聞く
- 生成されたコードと自分のコードを比較する

#### **検証する習慣**
生成されたコードは、必ず以下を確認：
1. 構文エラーがないか
2. 期待通りの結果が得られるか
3. エッジケース（空データ、大量データなど）でも動くか

#### **自分で考える**
Copilotはツールであり、学習の代わりにはなりません。
- 基本的な文法は自分で理解する
- なぜそのコードが必要か考える
- 別の方法も試してみる

---

### 🎓 推奨される学習の流れ

```
1. 教材を読んで概念を理解
   ↓
2. サンプルプログラムを実行して動作を確認
   ↓
3. 自分で似たようなプログラムを書いてみる
   ↓
4. 困ったらCopilotに質問・コード生成を依頼
   ↓
5. 生成されたコードを理解して実験
   ↓
6. 練習問題で定着
```

**大切なのは「AIと協働する」姿勢です。丸投げではなく、一緒に学ぶパートナーとして活用しましょう！**

Copilotを使いながら、「なぜこのコードが生成されたのか」「他にどんな書き方があるか」を常に考えることで、プログラミングスキルが確実に向上します。

---

## 3.4.2 データの追加

既存のデータフレームに新しいデータを追加する方法を学びましょう。行を追加する方法と、列を追加する方法の2つがあります。

### 3.4.2.1 行の追加（データフレームの結合）

既存のデータフレームに新しい行を追加して、新しいデータフレームを作成します。

#### 元のデータ → 新しいデータ

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| B | 90 | 80 | m |
| C | 70 | 90 | m |
| D | 90 | 100 | f |

↓ **Eさんを追加**

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| B | 90 | 80 | m |
| C | 70 | 90 | m |
| D | 90 | 100 | f |
| E | 80 | 80 | m |

#### 📝 sample06_add_row.py

```python
# pandasライブラリを読み込む
import pandas as pd

# 元のデータフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

print("元のデータフレーム:")
print(my_df)

# 追加する行を作成
new_row = pd.DataFrame({
    'name':    ['E'],
    'english': [80],
    'math':    [80],
    'gender':  ['m']
})

# 行を追加して新しいデータフレームを作成
my_df2 = pd.concat([my_df, new_row], ignore_index=True)

print("\n行を追加した後:")
print(my_df2)
```

**実行方法：**

```bash
(class) $ python sample06_add_row.py
```

**期待される出力：**

```
元のデータフレーム:
  name  english  math gender
0    A       60    70      f
1    B       90    80      m
2    C       70    90      m
3    D       90   100      f

行を追加した後:
  name  english  math gender
0    A       60    70      f
1    B       90    80      m
2    C       70    90      m
3    D       90   100      f
4    E       80    80      m
```

#### 📝 sample06_add_row.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# 元のデータフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

print("元のデータフレーム:")
print(my_df)

# 追加する行を作成
new_row <- data.frame(
  name    = "E",
  english = 80,
  math    = 80,
  gender  = "m"
)

# 行を追加して新しいデータフレームを作成
my_df2 <- rbind(my_df, new_row)

print("行を追加した後:")
print(my_df2)
```

**実行方法：**

```bash
$ Rscript sample06_add_row.R
```

**期待される出力：**

```
[1] "元のデータフレーム:"
  name english math gender
1    A      60   70      f
2    B      90   80      m
3    C      70   90      m
4    D      90  100      f
[1] "行を追加した後:"
  name english math gender
1    A      60   70      f
2    B      90   80      m
3    C      70   90      m
4    D      90  100      f
5    E      80   80      m
```

#### 🔍 コードの解説

**Python版：**
- `pd.concat([df1, df2])`: 複数のデータフレームを結合
- `ignore_index=True`: 行番号を振り直す（0から連番）
- 新しいデータフレームが作成される（元のデータフレームは変更されない）

**R版：**
- `rbind(df1, df2)`: 行方向（row）にデータフレームを結合
- "row bind"（行を結合）の意味
- 新しいデータフレームが作成される

#### ⚠️ 重要な注意点

**1. 新しいデータフレームが作られる**

元のデータフレーム（`my_df`）は変更されません。元のデータフレームを更新したい場合は：

```python
# 元のデータフレームを更新する場合
my_df = pd.concat([my_df, new_row], ignore_index=True)
```

**2. 列の構造が同じでなければならない**

追加する行は、元のデータフレームと同じ列を持っている必要があります。列名が違ったり、列が足りなかったりするとエラーになります。

**3. パフォーマンスの注意**

この方法を繰り返し使うとプログラムが遅くなります。大量のデータを追加する場合は、すべてのデータを準備してから一度にデータフレームを作成する方が効率的です。

---

### 3.4.2.2 列の追加

既存のデータフレームに新しい列を追加して、新しいデータフレームを作成します。

#### 元のデータ → 新しいデータ

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| B | 90 | 80 | m |
| C | 70 | 90 | m |
| D | 90 | 100 | f |

↓ **id列を追加**

| name | english | math | gender | id |
| :--- | :--- | :--- | :--- | :--- |
| A | 60 | 70 | f | 1 |
| B | 90 | 80 | m | 2 |
| C | 70 | 90 | m | 3 |
| D | 90 | 100 | f | 4 |

#### 📝 sample07_add_column.py

```python
# pandasライブラリを読み込む
import pandas as pd

# 元のデータフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

print("元のデータフレーム:")
print(my_df)

# 方法1: assignを使って新しいデータフレームを作成
my_df2 = my_df.assign(id=[1, 2, 3, 4])

print("\n列を追加した後（新しいデータフレーム）:")
print(my_df2)

# 方法2: 元のデータフレームを直接更新
my_df3 = my_df.copy()  # コピーを作成
my_df3['id'] = [1, 2, 3, 4]  # 列を追加

print("\n直接更新した場合:")
print(my_df3)
```

**実行方法：**

```bash
(class) $ python sample07_add_column.py
```

**期待される出力：**

```
元のデータフレーム:
  name  english  math gender
0    A       60    70      f
1    B       90    80      m
2    C       70    90      m
3    D       90   100      f

列を追加した後（新しいデータフレーム）:
  name  english  math gender  id
0    A       60    70      f   1
1    B       90    80      m   2
2    C       70    90      m   3
3    D       90   100      f   4

直接更新した場合:
  name  english  math gender  id
0    A       60    70      f   1
1    B       90    80      m   2
2    C       70    90      m   3
3    D       90   100      f   4
```

#### 📝 sample07_add_column.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# 元のデータフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

print("元のデータフレーム:")
print(my_df)

# 方法1: mutateを使って新しいデータフレームを作成
my_df2 <- my_df %>% 
  mutate(id = c(1, 2, 3, 4))

print("列を追加した後（新しいデータフレーム）:")
print(my_df2)

# 方法2: 元のデータフレームを直接更新
my_df3 <- my_df  # コピー
my_df3["id"] <- c(1, 2, 3, 4)  # 列を追加

print("直接更新した場合:")
print(my_df3)
```

**実行方法：**

```bash
$ Rscript sample07_add_column.R
```

**期待される出力：**

```
[1] "元のデータフレーム:"
  name english math gender
1    A      60   70      f
2    B      90   80      m
3    C      70   90      m
4    D      90  100      f
[1] "列を追加した後（新しいデータフレーム）:"
  name english math gender id
1    A      60   70      f  1
2    B      90   80      m  2
3    C      70   90      m  3
4    D      90  100      f  4
[1] "直接更新した場合:"
  name english math gender id
1    A      60   70      f  1
2    B      90   80      m  2
3    C      70   90      m  3
4    D      90  100      f  4
```

#### 🔍 コードの解説

**Python版：**
- `.assign(列名=データ)`: 新しい列を追加した新しいデータフレームを作成
- `df['列名'] = データ`: 既存のデータフレームに列を直接追加
- `.copy()`: データフレームのコピーを作成（元のデータを保護）

**R版：**
- `mutate(列名 = データ)`: 新しい列を追加（tidyverseの機能）
- `%>%`: パイプ演算子（データを次の関数に渡す）
- `df["列名"] <- データ`: 直接列を追加

#### 💡 2つの方法の使い分け

**新しいデータフレームを作る方法：**
- 元のデータを保持したい場合
- 処理の流れを明確にしたい場合
- データ処理のパイプラインを構築する場合

**直接更新する方法：**
- メモリを節約したい場合
- 一時的な計算結果を追加する場合
- インタラクティブな分析の場合

#### ⚠️ 重要な注意点

**1. データの長さが一致する必要がある**

追加する列のデータは、データフレームの行数と同じ長さでなければなりません。

```python
# ❌ エラー: 行数が4なのにデータが3つ
my_df.assign(id=[1, 2, 3])  # エラー！

# ✅ 正しい: 行数と同じ4つのデータ
my_df.assign(id=[1, 2, 3, 4])  # OK
```

**2. Pythonでのコピーの重要性**

Pythonで元のデータフレームを保護したい場合は、必ず `.copy()` を使います。

```python
# ❌ 危険: my_dfとmy_df3が同じオブジェクトを参照
my_df3 = my_df
my_df3['id'] = [1, 2, 3, 4]
# my_dfも変更されてしまう！

# ✅ 安全: コピーを作成
my_df3 = my_df.copy()
my_df3['id'] = [1, 2, 3, 4]
# my_dfは変更されない
```

---

## 💡 GitHub Copilot活用ガイド（3.4.2 データの追加）

### このセクションで学んだことをCopilotで実践

データフレームへの行や列の追加は、データ分析でよく行う操作です。新しいデータが入ってきたとき、計算結果を追加したいとき、データを統合したいときなど、様々な場面で使います。Copilotを活用して、これらの操作を効率的に行えるようになりましょう。

---

### 🚀 使えるプロンプト例

#### プロンプト例1: 複数行の一括追加 [★☆☆]

**Copilot Chatに入力**:
```
Pythonで、学生成績データフレームに3人分の新しいデータを一度に追加してください。
元のデータフレームには、name, english, math, genderの列があります。
追加するデータ:
- F, 85, 88, f
- G, 78, 92, m
- H, 95, 87, f
pd.concatを使用してください。
```

**期待される動作**:
- 3行分のデータを持つ新しいデータフレームを作成
- `pd.concat()`で元のデータフレームと結合
- `ignore_index=True`で行番号を振り直し

**やってみよう**:
1. 新しいファイル `copilot_practice05.py` を作成
2. まず元のデータフレーム（A〜Dの4人分）を作成
3. Copilotに上記プロンプトを入力
4. 生成されたコードで3人を追加し、合計7人になることを確認

---

#### プロンプト例2: 計算結果を新しい列として追加 [★★☆]

**Copilot Chatに入力**:
```
Rで、学生成績データフレームに以下の列を追加してください：
1. total列: englishとmathの合計点
2. average列: englishとmathの平均点
mutateを使って、既存のデータフレームから新しいデータフレームを作成してください。
```

**期待される動作**:
- `mutate()`で2つの列を同時に追加
- 既存の列を使った計算式が含まれる
- パイプ演算子（%>%）を使った読みやすいコード

**やってみよう**:
1. 新しいファイル `copilot_practice05.R` を作成
2. 学生データフレームを作成
3. Copilotで計算列を追加するコードを生成
4. 合計点と平均点が正しく計算されているか確認
5. さらに、合計点が180点以上なら "excellent"、それ以外なら "good" の列を追加してみる

---

#### プロンプト例3: 条件に応じた列の追加 [★★☆]

**Copilot Chatに入力**:
```
Pythonで、学生成績データフレームに "grade" 列を追加してください。
gradeの決定ルール:
- englishとmathの平均が90以上: "A"
- 80以上90未満: "B"
- 70以上80未満: "C"
- 70未満: "D"
assignメソッドとnumpy.whereまたはpd.cutを使用してください。
```

**期待される動作**:
- 条件分岐を使った列の生成
- 既存の2列から計算した結果を使用
- 見やすく整理されたコード

**やってみよう**:
1. 新しいファイル `copilot_practice06.py` を作成
2. Copilotでコードを生成
3. 各学生のgradeが正しく判定されているか確認
4. 境界値（90点、80点、70点）のデータで正しく動作するか検証

---

#### プロンプト例4: 2つのデータフレームの結合 [★★★]

**Copilot Chatに入力**:
```
Pythonで、2つのデータフレームを結合してください。
データフレーム1: 学生の試験成績（name, test1, test2）
データフレーム2: 学生の追加情報（name, age, class）
nameをキーとして結合し、すべての情報を含む1つのデータフレームを作成してください。
pd.mergeを使用してください。
```

**期待される動作**:
- 2つのデータフレームを作成
- `pd.merge()`でnameをキーに結合
- 結合後のデータフレームにすべての列が含まれる

**やってみよう**:
1. 新しいファイル `copilot_practice07.py` を作成
2. 2つのデータフレームを作成（一部の学生は片方にしかいない設定も試す）
3. Copilotで結合コードを生成
4. 内部結合（inner）、左結合（left）、外部結合（outer）の違いを実験

---

#### プロンプト例5: 行番号や日付を自動生成して追加 [★★☆]

**Copilot Chatに入力**:
```
Rで、データフレームに以下の列を追加してください：
1. row_id: 1から始まる連番
2. created_date: 今日の日付
3. random_score: 0から100のランダムな整数
データフレームの行数に応じて自動的に生成されるようにしてください。
```

**期待される動作**:
- `1:nrow(df)`で連番生成
- `Sys.Date()`で今日の日付取得
- `sample()`でランダム値生成

**やってみよう**:
1. 新しいファイル `copilot_practice06.R` を作成
2. 任意の行数のデータフレームを作成
3. Copilotで3つの列を追加するコードを生成
4. 実行するたびにrandom_scoreが変わることを確認

---

### 📚 Copilot活用のコツ

#### 1. **既存のコードに追加する形で依頼**

すでにデータフレームがある状態で、追加の操作を依頼すると効果的です。

```python
# 既存のコード
my_df = pd.DataFrame({...})

# ここにコメントを書く
# このデータフレームに total 列を追加（english + math）
```

Copilotは前後のコンテキストから、適切なコードを提案してくれます。

#### 2. **段階的に複雑にする**

まずシンプルな列追加から始めて、徐々に複雑な操作に挑戦しましょう。

1. 固定値の列を追加
2. 簡単な計算結果の列を追加
3. 条件分岐を含む列を追加
4. 複数のデータフレームを結合

#### 3. **エラーメッセージをCopilotに伝える**

エラーが出たら、そのメッセージをCopilotに伝えましょう。

```
次のエラーが出ました。修正方法を教えてください：
ValueError: Length of values does not match length of index
```

Copilotがエラーの原因と解決策を提案してくれます。

#### 4. **同じ操作のPython版とR版を比較**

Copilotに「同じ操作をRで書いてください」と依頼して、Python版とR版を比較してみましょう。言語間の違いを理解するのに役立ちます。

---

### ⚠️ 注意事項

#### **データの整合性を確認**
- 追加する行や列のサイズが正しいか確認
- データ型が適切か確認（数値を文字列として追加していないか等）
- 列名が重複していないか確認

#### **元のデータを保護**
- 元のデータフレームを保持したいなら、必ず新しいデータフレームを作成
- Pythonでは `.copy()` を使うことを忘れずに

#### **パフォーマンスを意識**
- ループ内で行を1つずつ追加するのは避ける
- 大量のデータを追加する場合は、事前にすべてのデータを準備してから一度に結合

#### **結合時のキーに注意**
- データフレームを結合する際は、キーとなる列の値が一致しているか確認
- 大文字小文字、スペースの有無などに注意

---

### 🎓 推奨される学習の流れ

```
1. 単純な列追加・行追加から始める
   ↓
2. 計算結果を列として追加
   ↓
3. 条件分岐を含む列の追加
   ↓
4. 複数のデータフレームの結合
   ↓
5. 実際のデータ分析で応用
```

**データの追加操作は、データ分析の基本中の基本です。Copilotを活用して、様々なパターンに慣れましょう！**

データフレームへの追加操作をマスターすれば、実際のデータ分析でデータを自在に扱えるようになります。エラーを恐れず、いろいろな追加方法を試してみてください。

---

## 3.4.3 データの取り出し

データフレームから必要なデータを取り出す方法を学びましょう。データ分析では、全体のデータから特定の部分だけを抽出して処理することが頻繁にあります。

> 📝 **注意**: 本項では、取り出した結果に `x` という名前を付ける場合、特に必要でなければ、その内容の確認は割愛します。

### 3.4.3.1 観測値の取り出し

データフレームから**特定の1つの値**（観測値）を取り出します。行と列を番号で指定して取り出します。

たとえば、Aさんの英語の点数（60点）を取り出す場合を考えます。

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| **A** | **60** | 70 | f |
| B | 90 | 80 | m |
| C | 70 | 90 | m |
| D | 90 | 100 | f |

#### 📝 sample08_extract_value.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# Aのenglishの値を取り出す（1行目、2列目）
# Pythonは0から数えるので、1行目は0、2列目は1
value = my_df.iloc[0, 1]

print(f"Aのenglishの点数: {value}")
```

**実行方法：**

```bash
(class) $ python sample08_extract_value.py
```

**期待される出力：**

```
Aのenglishの点数: 60
```

#### 📝 sample08_extract_value.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# Aのenglishの値を取り出す（1行目、2列目）
# Rは1から数えるので、1行目は1、2列目は2
value <- my_df[1, 2]

print(paste("Aのenglishの点数:", value))
```

**実行方法：**

```bash
$ Rscript sample08_extract_value.R
```

**期待される出力：**

```
[1] "Aのenglishの点数: 60"
```

#### 🔍 コードの解説

**Python版：**
- `.iloc[行番号, 列番号]`: 位置（番号）で要素を取り出す
- 行番号・列番号は**0から始まる**
- 1行目、2列目 = `[0, 1]`

**R版：**
- `[行番号, 列番号]`: 位置で要素を取り出す
- 行番号・列番号は**1から始まる**
- 1行目、2列目 = `[1, 2]`

#### ⚠️ PythonとRの違いに注意

**最も重要な違い：番号の開始位置**

| 言語 | 1行目 | 2行目 | 3行目 | 4行目 |
|:---|:---:|:---:|:---:|:---:|
| Python | 0 | 1 | 2 | 3 |
| R | 1 | 2 | 3 | 4 |

この違いは、データを取り出す際に常に意識する必要があります。

---

### 3.4.3.2 1列の取り出し（結果は1次元データ）

データフレームから**1つの列**を取り出します。結果は1次元データ（Pythonではシリーズ、Rではベクタ）になります。

| name | **english** | math | gender |
| :--- | :--- | :--- | :--- |
| A | **60** | 70 | f |
| B | **90** | 80 | m |
| C | **70** | 90 | m |
| D | **90** | 100 | f |

↓

**1次元データ**: 60, 90, 70, 90

#### 📝 sample09_extract_column.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 方法1: 列番号で取り出す
col1 = my_df.iloc[:, 1]
print("方法1（列番号）:")
print(col1)

# 方法2: 列名で取り出す（角括弧）
col2 = my_df['english']
print("\n方法2（列名・角括弧）:")
print(col2)

# 方法3: 列名で取り出す（ドット記法）
col3 = my_df.english
print("\n方法3（列名・ドット記法）:")
print(col3)
```

**実行方法：**

```bash
(class) $ python sample09_extract_column.py
```

**期待される出力：**

```
方法1（列番号）:
0    60
1    90
2    70
3    90
Name: english, dtype: int64

方法2（列名・角括弧）:
0    60
1    90
2    70
3    90
Name: english, dtype: int64

方法3（列名・ドット記法）:
0    60
1    90
2    70
3    90
Name: english, dtype: int64
```

#### 📝 sample09_extract_column.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 方法1: 列番号で取り出す
col1 <- my_df[, 2]
print("方法1（列番号）:")
print(col1)

# 方法2: 列名で取り出す（$記法）
col2 <- my_df$english
print("方法2（列名・$記法）:")
print(col2)

# 方法3: 列名で取り出す（角括弧）
col3 <- my_df[["english"]]
print("方法3（列名・角括弧）:")
print(col3)
```

**実行方法：**

```bash
$ Rscript sample09_extract_column.R
```

**期待される出力：**

```
[1] "方法1（列番号）:"
[1]  60  90  70  90
[1] "方法2（列名・$記法）:"
[1]  60  90  70  90
[1] "方法3（列名・角括弧）:"
[1]  60  90  70  90
```

#### 🔍 コードの解説

**Python版：**
- `.iloc[:, 列番号]`: `:` はすべての行を意味する
- `df['列名']`: 列名で取り出す（最も一般的）
- `df.列名`: ドット記法（列名にスペースがない場合のみ）

**R版：**
- `[, 列番号]`: すべての行、指定した列
- `df$列名`: ドル記法（便利だが制約あり）
- `df[["列名"]]`: 二重角括弧（最も汎用的）

#### 💡 どの方法を使うべきか

**列名がわかっている場合：**
- Python: `df['列名']` を推奨
- R: `df$列名` または `df[["列名"]]` を推奨

**列番号で取り出す場合：**
- プログラムで自動的に列を選択する場合
- 列名がわからない場合

#### ⚠️ ドット記法の制約

`df.列名` や `df$列名` は便利ですが、以下の場合は使えません。

- 列名にスペースが含まれる（例：`"test score"`）
- 列名が予約語と重複（例：`"max"`, `"min"`）
- 列名が変数に格納されている場合

このような場合は、角括弧を使います：`df['列名']` または `df[["列名"]]`

---

### 3.4.3.3 複数列の取り出し（結果はデータフレーム）

データフレームから**複数の列**を取り出します。結果は新しいデータフレームになります。

| **name** | english | **math** | gender |
| :--- | :--- | :--- | :--- |
| **A** | 60 | **70** | f |
| **B** | 90 | **80** | m |
| **C** | 70 | **90** | m |
| **D** | 90 | **100** | f |

↓

| name | math |
| :--- | :--- |
| A | 70 |
| B | 80 |
| C | 90 |
| D | 100 |

#### 📝 sample10_extract_columns.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 方法1: 列名のリストで取り出す
result1 = my_df[['name', 'math']]
print("方法1（列名のリスト）:")
print(result1)

# 方法2: 列番号で取り出す
result2 = my_df.iloc[:, [0, 2]]
print("\n方法2（列番号）:")
print(result2)

# 方法3: 不要な列を削除（dropで取り出し）
result3 = my_df.drop(columns=['english', 'gender'])
print("\n方法3（不要な列を削除）:")
print(result3)
```

**実行方法：**

```bash
(class) $ python sample10_extract_columns.py
```

**期待される出力：**

```
方法1（列名のリスト）:
  name  math
0    A    70
1    B    80
2    C    90
3    D   100

方法2（列番号）:
  name  math
0    A    70
1    B    80
2    C    90
3    D   100

方法3（不要な列を削除）:
  name  math
0    A    70
1    B    80
2    C    90
3    D   100
```

#### 📝 sample10_extract_columns.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 方法1: selectで列名を指定
result1 <- my_df %>% select(name, math)
print("方法1（select）:")
print(result1)

# 方法2: 列番号で取り出す
result2 <- my_df[, c(1, 3)]
print("方法2（列番号）:")
print(result2)

# 方法3: 不要な列を除外
result3 <- my_df %>% select(-c(english, gender))
print("方法3（不要な列を除外）:")
print(result3)
```

**実行方法：**

```bash
$ Rscript sample10_extract_columns.R
```

**期待される出力：**

```
[1] "方法1（select）:"
  name math
1    A   70
2    B   80
3    C   90
4    D  100
[1] "方法2（列番号）:"
  name math
1    A   70
2    B   80
3    C   90
4    D  100
[1] "方法3（不要な列を除外）:"
  name math
1    A   70
2    B   80
3    C   90
4    D  100
```

#### 🔍 コードの解説

**Python版：**
- `df[['列1', '列2']]`: 列名のリストで複数列を取り出す（二重角括弧に注意）
- `.iloc[:, [番号1, 番号2]]`: 列番号で取り出す
- `.drop(columns=[...])`: 不要な列を削除して残りを取得

**R版：**
- `select(列1, 列2)`: tidyverseの関数で列を選択
- `[, c(番号1, 番号2)]`: 列番号で取り出す
- `select(-c(列1, 列2))`: マイナスで不要な列を除外

#### 💡 使い分けのポイント

**必要な列が少ない場合：**
- 列名を直接指定して取り出す
- `df[['列1', '列2']]` または `select(列1, 列2)`

**不要な列が少ない場合：**
- 不要な列を除外して取り出す
- `.drop(columns=[...])` または `select(-c(...))`

#### ⚠️ 単一角括弧と二重角括弧の違い（Python）

Pythonでは、角括弧の数に注意が必要です。

```python
# ❌ 単一角括弧 - 1列の取り出し（シリーズになる）
my_df['name']  # シリーズ

# ✅ 二重角括弧 - 複数列の取り出し（データフレームになる）
my_df[['name']]  # データフレーム

# ✅ 複数列の場合も二重角括弧
my_df[['name', 'math']]  # データフレーム
```

---

### 3.4.3.4 複数行の取り出し（結果はデータフレーム）

データフレームから**複数の行**を取り出します。結果は新しいデータフレームになります。

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| **A** | **60** | **70** | **f** |
| B | 90 | 80 | m |
| **C** | **70** | **90** | **m** |
| D | 90 | 100 | f |

↓

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| C | 70 | 90 | m |

#### 📝 sample11_extract_rows.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 方法1: 行番号のリストで取り出す
result1 = my_df.iloc[[0, 2], :]
print("方法1（行番号のリスト）:")
print(result1)

# 方法2: takeメソッドで取り出す
result2 = my_df.take([0, 2])
print("\n方法2（takeメソッド）:")
print(result2)

# 方法3: 不要な行を削除
result3 = my_df.drop([1, 3])
print("\n方法3（不要な行を削除）:")
print(result3)
```

**実行方法：**

```bash
(class) $ python sample11_extract_rows.py
```

**期待される出力：**

```
方法1（行番号のリスト）:
  name  english  math gender
0    A       60    70      f
2    C       70    90      m

方法2（takeメソッド）:
  name  english  math gender
0    A       60    70      f
2    C       70    90      m

方法3（不要な行を削除）:
  name  english  math gender
0    A       60    70      f
2    C       70    90      m
```

#### 📝 sample11_extract_rows.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 方法1: 行番号のベクタで取り出す
result1 <- my_df[c(1, 3), ]
print("方法1（行番号のベクタ）:")
print(result1)

# 方法2: 不要な行を除外（マイナス）
result2 <- my_df[-c(2, 4), ]
print("方法2（不要な行を除外）:")
print(result2)
```

**実行方法：**

```bash
$ Rscript sample11_extract_rows.R
```

**期待される出力：**

```
[1] "方法1（行番号のベクタ）:"
  name english math gender
1    A      60   70      f
3    C      70   90      m
[1] "方法2（不要な行を除外）:"
  name english math gender
1    A      60   70      f
3    C      70   90      m
```

#### 🔍 コードの解説

**Python版：**
- `.iloc[[行番号1, 行番号2], :]`: `:` はすべての列を意味する
- `.take([行番号1, 行番号2])`: 行を取り出す専用メソッド
- `.drop([行番号1, 行番号2])`: 指定した行を削除

**R版：**
- `[c(行番号1, 行番号2), ]`: 行番号のベクタで指定
- `[-c(行番号1, 行番号2), ]`: マイナスで不要な行を除外

#### 💡 行の指定方法

**連続した行を取り出す場合：**

```python
# Python: スライス記法
my_df.iloc[1:3, :]  # 2行目から3行目（1, 2を取り出す。3は含まない）

# R: コロン記法
my_df[2:3, ]  # 2行目から3行目
```

**特定の行を取り出す場合：**
- リスト（Python）またはベクタ（R）で行番号を指定

---

### 3.4.3.5 検索（条件による抽出）

データフレームから**条件に合う行**を取り出します。これはデータ分析で最も頻繁に使う操作の一つです。

#### 単一条件での検索

男性（gender == "m"）の学生だけを取り出します。

| name | english | math | **gender** |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| **B** | **90** | **80** | **m** |
| **C** | **70** | **90** | **m** |
| D | 90 | 100 | f |

↓

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| B | 90 | 80 | m |
| C | 70 | 90 | m |

#### 📝 sample12_filter.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 方法1: 条件式で直接フィルタ
result1 = my_df[my_df['gender'] == 'm']
print("方法1（直接フィルタ）:")
print(result1)

# 方法2: queryメソッドを使用
result2 = my_df.query('gender == "m"')
print("\n方法2（queryメソッド）:")
print(result2)

# 複数条件: 英語が80点超かつ男性
result3 = my_df[(my_df['english'] > 80) & (my_df['gender'] == 'm')]
print("\n複数条件（AND）:")
print(result3)

# 最高点を取った学生を検索
max_score = my_df['english'].max()
result4 = my_df[my_df['english'] == max_score]
print("\n英語の最高点:")
print(result4)
```

**実行方法：**

```bash
(class) $ python sample12_filter.py
```

**期待される出力：**

```
方法1（直接フィルタ）:
  name  english  math gender
1    B       90    80      m
2    C       70    90      m

方法2（queryメソッド）:
  name  english  math gender
1    B       90    80      m
2    C       70    90      m

複数条件（AND）:
  name  english  math gender
1    B       90    80      m

英語の最高点:
  name  english  math gender
1    B       90    80      m
3    D       90   100      f
```

#### 📝 sample12_filter.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 方法1: 条件式で直接フィルタ
result1 <- my_df[my_df$gender == "m", ]
print("方法1（直接フィルタ）:")
print(result1)

# 方法2: filterを使用
result2 <- my_df %>% filter(gender == "m")
print("方法2（filter）:")
print(result2)

# 複数条件: 英語が80点超かつ男性
result3 <- my_df %>% filter(english > 80 & gender == "m")
print("複数条件（AND）:")
print(result3)

# 最高点を取った学生を検索
result4 <- my_df %>% filter(english == max(english))
print("英語の最高点:")
print(result4)
```

**実行方法：**

```bash
$ Rscript sample12_filter.R
```

**期待される出力：**

```
[1] "方法1（直接フィルタ）:"
  name english math gender
2    B      90   80      m
3    C      70   90      m
[1] "方法2（filter）:"
  name english math gender
2    B      90   80      m
3    C      70   90      m
[1] "複数条件（AND）:"
  name english math gender
2    B      90   80      m
[1] "英語の最高点:"
  name english math gender
2    B      90   80      m
4    D      90  100      f
```

#### 🔍 コードの解説

**Python版：**
- `df[条件式]`: 条件に合う行を抽出
- `.query('条件')`: SQL風の条件式で抽出
- `&`: AND演算子（各条件を括弧で囲む必要あり）
- `|`: OR演算子

**R版：**
- `df[条件式, ]`: 条件に合う行を抽出
- `filter(条件)`: tidyverseの関数（推奨）
- `&`: AND演算子
- `|`: OR演算子

#### 💡 複数条件の書き方

**AND条件（両方を満たす）：**

```python
# Python
df[(条件1) & (条件2)]

# R
df %>% filter(条件1 & 条件2)
```

**OR条件（どちらかを満たす）：**

```python
# Python
df[(条件1) | (条件2)]

# R
df %>% filter(条件1 | 条件2)
```

#### ⚠️ よくあるエラー

**Python: `and` ではなく `&` を使う**

```python
# ❌ エラー
my_df[(my_df['english'] > 80) and (my_df['gender'] == 'm')]

# ✅ 正しい
my_df[(my_df['english'] > 80) & (my_df['gender'] == 'm')]
```

理由: `and` は単一の真偽値に対する演算子で、配列に対しては `&` を使います。

**括弧を忘れない**

`&` や `|` は優先順位が高いので、各条件を括弧で囲む必要があります。

---

### 3.4.3.6 並べ替え

データフレームを特定の列の値に基づいて**並べ替え**ます。

#### 元のデータ → 並べ替え後

| name | **english** | math | gender |
| :--- | :--- | :--- | :--- |
| A | **60** | 70 | f |
| B | **90** | 80 | m |
| C | **70** | 90 | m |
| D | **90** | 100 | f |

↓ **englishの昇順（小さい順）**

| name | english | math | gender |
| :--- | :--- | :--- | :--- |
| A | 60 | 70 | f |
| C | 70 | 90 | m |
| B | 90 | 80 | m |
| D | 90 | 100 | f |

#### 📝 sample13_sort.py

```python
# pandasライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 昇順（小さい順）に並べ替え
result1 = my_df.sort_values('english')
print("昇順（小さい順）:")
print(result1)

# 降順（大きい順）に並べ替え
result2 = my_df.sort_values('english', ascending=False)
print("\n降順（大きい順）:")
print(result2)

# 複数列で並べ替え（english降順、次にmath昇順）
result3 = my_df.sort_values(['english', 'math'], 
                             ascending=[False, True])
print("\n複数列で並べ替え:")
print(result3)
```

**実行方法：**

```bash
(class) $ python sample13_sort.py
```

**期待される出力：**

```
昇順（小さい順）:
  name  english  math gender
0    A       60    70      f
2    C       70    90      m
1    B       90    80      m
3    D       90   100      f

降順（大きい順）:
  name  english  math gender
1    B       90    80      m
3    D       90   100      f
2    C       70    90      m
0    A       60    70      f

複数列で並べ替え:
  name  english  math gender
1    B       90    80      m
3    D       90   100      f
2    C       70    90      m
0    A       60    70      f
```

#### 📝 sample13_sort.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 昇順（小さい順）に並べ替え
result1 <- my_df %>% arrange(english)
print("昇順（小さい順）:")
print(result1)

# 降順（大きい順）に並べ替え
result2 <- my_df %>% arrange(-english)
print("降順（大きい順）:")
print(result2)

# 複数列で並べ替え（english降順、次にmath昇順）
result3 <- my_df %>% arrange(-english, math)
print("複数列で並べ替え:")
print(result3)
```

**実行方法：**

```bash
$ Rscript sample13_sort.R
```

**期待される出力：**

```
[1] "昇順（小さい順）:"
  name english math gender
1    A      60   70      f
2    C      70   90      m
3    B      90   80      m
4    D      90  100      f
[1] "降順（大きい順）:"
  name english math gender
1    B      90   80      m
2    D      90  100      f
3    C      70   90      m
4    A      60   70      f
[1] "複数列で並べ替え:"
  name english math gender
1    B      90   80      m
2    D      90  100      f
3    C      70   90      m
4    A      60   70      f
```

#### 🔍 コードの解説

**Python版：**
- `.sort_values('列名')`: 指定した列で並べ替え（デフォルトは昇順）
- `ascending=False`: 降順に並べ替え
- 複数列: リストで列名を指定、`ascending` もリストで指定

**R版：**
- `arrange(列名)`: tidyverseの関数で並べ替え（昇順）
- `arrange(-列名)`: マイナスを付けると降順
- 複数列: カンマで区切って列名を指定

#### 💡 並べ替えの用途

**データ分析での使用例：**
- トップ10を表示（降順に並べて上位10件）
- 時系列データを時間順に整理
- カテゴリごとにグループ化して並べ替え
- 最小値・最大値を確認

#### ⚠️ 元のデータは変更されない

`.sort_values()` や `arrange()` は、新しいデータフレームを返します。元のデータフレームは変更されません。

元のデータフレームを並べ替えたい場合：

```python
# Python
my_df = my_df.sort_values('english')

# R
my_df <- my_df %>% arrange(english)
```

---

## 💡 GitHub Copilot活用ガイド（3.4.3 データの取り出し）

### このセクションで学んだことをCopilotで実践

データの取り出しは、データ分析の中心的な操作です。観測値、列、行の取り出し、条件検索、並べ替えなど、様々な方法を学びました。これらを組み合わせることで、複雑なデータ処理も実現できます。Copilotを活用して、効率的にデータを扱えるようになりましょう。

---

### 🚀 使えるプロンプト例

#### プロンプト例1: 条件検索の基本 [★★☆]

**Copilot Chatに入力**:
```
Pythonで、学生成績データフレームから以下の条件で検索してください：
1. 英語が80点以上の学生
2. 数学が90点以上の学生
3. 英語と数学の両方が80点以上の学生
それぞれ別々のコードで書いてください。
```

**期待される動作**:
- 条件式を使ったフィルタリングが3つ生成される
- AND条件（`&`）の使い方が示される
- わかりやすい変数名が使われる

**やってみよう**:
1. 新しいファイル `copilot_practice08.py` を作成
2. 学生データフレームを作成
3. Copilotで3つの検索コードを生成
4. それぞれの結果を確認し、条件が正しく機能しているか検証

---

#### プロンプト例2: 複数列の選択と並べ替え [★★☆]

**Copilot Chatに入力**:
```
Rで、学生成績データフレームから以下の処理をしてください：
1. name, english, mathの列だけを選択
2. englishの降順（高得点順）に並べ替え
3. 上位3名を表示
パイプ演算子（%>%）を使って1つの流れで書いてください。
```

**期待される動作**:
- `select()` で列を選択
- `arrange()` で並べ替え
- `head()` で上位を取得
- パイプでつないだ読みやすいコード

**やってみよう**:
1. 新しいファイル `copilot_practice07.R` を作成
2. データフレームを作成
3. Copilotでパイプラインコードを生成
4. 各ステップがどう動いているか確認
5. 列や並べ替えの条件を変えて実験

---

#### プロンプト例3: 複雑な条件での検索 [★★★]

**Copilot Chatに入力**:
```
Pythonで、学生成績データフレームから以下の条件で検索してください：
- 英語が70点以上90点未満 OR 数学が80点以上
- かつ gender が 'f'
結果を英語の点数順（昇順）に並べてください。
queryメソッドを使わず、条件式で書いてください。
```

**期待される動作**:
- OR条件（`|`）とAND条件（`&`）の組み合わせ
- 括弧を使った正しい条件式
- `.sort_values()` で並べ替え

**やってみよう**:
1. 新しいファイル `copilot_practice09.py` を作成
2. データフレームを作成（10人程度のデータ）
3. Copilotで複雑な条件の検索コードを生成
4. 条件を変えて動作を確認（AND/ORの組み合わせ）
5. 同じ処理を `.query()` メソッドでも書いてみる

---

#### プロンプト例4: トップN分析 [★★★]

**Copilot Chatに入力**:
```
Rで、学生成績データフレームに対して以下を実行してください：
1. englishとmathの合計点（total）を計算して列を追加
2. totalの降順に並べ替え
3. 上位5名のname, english, math, totalを表示
tidyverseのパイプラインで書いてください。
```

**期待される動作**:
- `mutate()` で計算列を追加
- `arrange(-total)` で降順に並べ替え
- `select()` と `head()` で必要な部分を取得
- パイプでつないだ一連の処理

**やってみよう**:
1. 新しいファイル `copilot_practice08.R` を作成
2. 10人以上の学生データを作成
3. Copilotでトップ5分析のコードを生成
4. 上位10名、上位3名など、表示数を変えて実験
5. 平均点でのランキングも作ってみる

---

#### プロンプト例5: データの更新（条件付き） [★★★]

**Copilot Chatに入力**:
```
Pythonで、学生成績データフレームに対して以下の処理をしてください：
1. 英語が60点未満の学生の英語の点数を60点に引き上げる
2. 数学が95点以上の学生に "excellent" という新しい列を追加（それ以外は空文字）
3. 処理後のデータフレーム全体を表示
元のデータフレームを直接更新する方法で書いてください。
```

**期待される動作**:
- `.loc[]` を使った条件付き更新
- 条件に応じた列の追加
- わかりやすいコメント付きコード

**やってみよう**:
1. 新しいファイル `copilot_practice10.py` を作成
2. データフレームを作成（条件に合うデータを含める）
3. Copilotで更新コードを生成
4. 更新前後でデータが正しく変わったか確認
5. 他の条件（例：合計点で判定）でも試す

---

### 📚 Copilot活用のコツ

#### 1. **条件式を段階的に構築**

複雑な条件は、まずシンプルな条件から始めます。

```python
# ステップ1: 単一条件
df[df['english'] > 80]

# ステップ2: AND条件を追加（ここでCopilotに聞く）
# 英語80点以上かつ数学70点以上
```

Copilotが前のコードを参考に、適切な条件式を提案してくれます。

#### 2. **メソッドチェーンを活用**

複数の操作を連続して行う場合、Copilotに「パイプライン」や「メソッドチェーン」と伝えましょう。

```
「以下の処理をメソッドチェーンで書いてください」
1. 列を選択
2. 条件でフィルタ
3. 並べ替え
```

#### 3. **具体的なデータ例を示す**

Copilotに期待する結果を示すと、より正確なコードが生成されます。

```
「データフレームから、english列が[60, 90, 70, 90]のとき、
90の行だけを取り出すコードを書いてください」
```

#### 4. **エラーパターンから学ぶ**

よくあるエラーをCopilotに聞いてみましょう。

```
「データフレームのフィルタリングで
`and` と `&` の違いを教えてください。
どちらを使うべきですか？」
```

---

### ⚠️ 注意事項

#### **インデックスの扱いに注意**
- フィルタや並べ替え後も元のインデックスが保持される
- 必要に応じて `.reset_index(drop=True)` で振り直す

#### **条件式の括弧を忘れずに**
- Python: `&` や `|` は優先順位が高いので括弧が必須
- エラーメッセージをよく読んで対処

#### **元のデータの保護**
- 取り出し操作は元のデータを変更しない
- 更新したい場合は明示的に代入

#### **パフォーマンスを意識**
- 大量データの場合、条件を絞り込んでから処理
- 不要な列は早めに削除

---

### 🎓 推奨される学習の流れ

```
1. 単純な取り出し（1列、1行）から始める
   ↓
2. 複数列・複数行の取り出しを練習
   ↓
3. 単一条件での検索を試す
   ↓
4. 複数条件（AND/OR）での検索に挑戦
   ↓
5. 並べ替えと組み合わせる
   ↓
6. 実データで複雑な分析を実践
```

**データの取り出しをマスターすれば、データ分析の8割はできるようになります！**

Copilotを活用しながら、様々な取り出しパターンを試してみてください。エラーを恐れず、「こんな取り出し方はできるかな？」と実験する姿勢が大切です。

---

## 3.4.4 補足：行列

機械学習のアルゴリズムでは**行列**（数を長方形に並べたもの）をよく使います。ここでは、行列の作り方と基本的な使い方を紹介します。

### 3.4.4.1 行列の生成

12個の数値から、3行4列の行列を作ります。

$$
A = \begin{pmatrix}
2 & 3 & 5 & 7 \\
11 & 13 & 17 & 19 \\
23 & 29 & 31 & 37
\end{pmatrix}
$$

#### 📝 sample14_matrix_basic.py

```python
# numpyライブラリを読み込む
import numpy as np

# 1次元データを作成
data = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37]

# 3行4列の行列に変形
A = np.array(data).reshape(3, 4)

print("行列A:")
print(A)

# 行列のサイズ確認
print(f"\n行列のサイズ: {A.shape}")
print(f"行数: {A.shape[0]}, 列数: {A.shape[1]}")
```

**実行方法：**

```bash
(class) $ python sample14_matrix_basic.py
```

**期待される出力：**

```
行列A:
[[ 2  3  5  7]
 [11 13 17 19]
 [23 29 31 37]]

行列のサイズ: (3, 4)
行数: 3, 列数: 4
```

#### 📝 sample14_matrix_basic.R

```r
# 1次元データを作成
data <- c(2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37)

# 3行4列の行列に変形
A <- matrix(
  data = data,
  nrow = 3,
  byrow = TRUE
)

print("行列A:")
print(A)

# 行列のサイズ確認
print(paste("行数:", nrow(A), "列数:", ncol(A)))
```

**実行方法：**

```bash
$ Rscript sample14_matrix_basic.R
```

**期待される出力：**

```
[1] "行列A:"
     [,1] [,2] [,3] [,4]
[1,]    2    3    5    7
[2,]   11   13   17   19
[3,]   23   29   31   37
[1] "行数: 3 列数: 4"
```

#### 🔍 コードの解説

**Python版：**
- `np.array(data)`: リストをNumPy配列に変換
- `.reshape(3, 4)`: 3行4列に変形
- `.reshape(3, -1)` や `.reshape(-1, 4)` でも可（-1は自動計算）

**R版：**
- `matrix(data, nrow=3, byrow=TRUE)`: 行列を生成
- `byrow=TRUE`: 行ごとにデータを配置（デフォルトは列ごと）

---

### 3.4.4.2 データフレームと行列の変換

データフレームの数値部分を行列に変換したり、その逆を行ったりします。

#### データフレーム → 行列

| name | **english** | **math** | gender |
| :--- | :--- | :--- | :--- |
| A | **60** | **70** | f |
| B | **90** | **80** | m |
| C | **70** | **90** | m |
| D | **90** | **100** | f |

↓ **数値部分のみ抽出**

$$
\begin{pmatrix}
60 & 70 \\
90 & 80 \\
70 & 90 \\
90 & 100
\end{pmatrix}
$$

#### 📝 sample15_df_to_matrix.py

```python
# 必要なライブラリを読み込む
import pandas as pd

# データフレームを作成
my_df = pd.DataFrame({
    'name':    ['A', 'B', 'C', 'D'],
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100],
    'gender':  ['f', 'm', 'm', 'f']
})

# 数値列を行列に変換
A = my_df[['english', 'math']].values

print("行列A:")
print(A)

# 行列からデータフレームに戻す
df_new = pd.DataFrame(A, columns=['english', 'math'])

print("\n行列からデータフレーム:")
print(df_new)
```

**実行方法：**

```bash
(class) $ python sample15_df_to_matrix.py
```

**期待される出力：**

```
行列A:
[[ 60  70]
 [ 90  80]
 [ 70  90]
 [ 90 100]]

行列からデータフレーム:
   english  math
0       60    70
1       90    80
2       70    90
3       90   100
```

#### 📝 sample15_df_to_matrix.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# データフレームを作成
my_df <- data.frame(
  name    = c("A", "B", "C", "D"),
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100),
  gender  = c("f", "m", "m", "f")
)

# 数値列を行列に変換
A <- my_df[, c(2, 3)] %>% as.matrix()

print("行列A:")
print(A)

# 行列からデータフレームに戻す
df_new <- as.data.frame(A)

print("行列からデータフレーム:")
print(df_new)
```

**実行方法：**

```bash
$ Rscript sample15_df_to_matrix.R
```

**期待される出力：**

```
[1] "行列A:"
  english math
A      60   70
B      90   80
C      70   90
D      90  100
[1] "行列からデータフレーム:"
  english math
1      60   70
2      90   80
3      70   90
4      90  100
```

---

### 3.4.4.3 行列の転置

行列の**転置**（行と列を入れ替える）を求めます。

$$
A = \begin{pmatrix}
60 & 70 \\
90 & 80 \\
70 & 90 \\
90 & 100
\end{pmatrix}
\quad \Rightarrow \quad
A^T = \begin{pmatrix}
60 & 90 & 70 & 90 \\
70 & 80 & 90 & 100
\end{pmatrix}
$$

#### 📝 sample16_matrix_transpose.py

```python
# 必要なライブラリを読み込む
import pandas as pd

# データフレームから行列を作成
my_df = pd.DataFrame({
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100]
})
A = my_df.values

print("元の行列A:")
print(A)

# 転置行列を計算
A_T = A.T

print("\n転置行列A^T:")
print(A_T)
```

**実行方法：**

```bash
(class) $ python sample16_matrix_transpose.py
```

**期待される出力：**

```
元の行列A:
[[ 60  70]
 [ 90  80]
 [ 70  90]
 [ 90 100]]

転置行列A^T:
[[ 60  90  70  90]
 [ 70  80  90 100]]
```

#### 📝 sample16_matrix_transpose.R

```r
# データフレームから行列を作成
my_df <- data.frame(
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100)
)
A <- as.matrix(my_df)

print("元の行列A:")
print(A)

# 転置行列を計算
A_T <- t(A)

print("転置行列A^T:")
print(A_T)
```

**実行方法：**

```bash
$ Rscript sample16_matrix_transpose.R
```

**期待される出力：**

```
[1] "元の行列A:"
     english math
[1,]      60   70
[2,]      90   80
[3,]      70   90
[4,]      90  100
[1] "転置行列A^T:"
        [,1] [,2] [,3] [,4]
english   60   90   70   90
math      70   80   90  100
```

---

### 3.4.4.4 行列の積

行列の積 $A^T A$ を計算します。

$$
A^T A = \begin{pmatrix}
60 & 90 & 70 & 90 \\
70 & 80 & 90 & 100
\end{pmatrix}
\begin{pmatrix}
60 & 70 \\
90 & 80 \\
70 & 90 \\
90 & 100
\end{pmatrix}
=
\begin{pmatrix}
24700 & 26700 \\
26700 & 29400
\end{pmatrix}
$$

#### 📝 sample17_matrix_multiply.py

```python
# 必要なライブラリを読み込む
import pandas as pd

# データフレームから行列を作成
my_df = pd.DataFrame({
    'english': [60, 90, 70, 90],
    'math':    [70, 80, 90, 100]
})
A = my_df.values

print("行列A:")
print(A)

# 転置行列
A_T = A.T
print("\n転置行列A^T:")
print(A_T)

# 行列の積を計算（@演算子を使用）
result = A_T @ A

print("\nA^T A:")
print(result)
```

**実行方法：**

```bash
(class) $ python sample17_matrix_multiply.py
```

**期待される出力：**

```
行列A:
[[ 60  70]
 [ 90  80]
 [ 70  90]
 [ 90 100]]

転置行列A^T:
[[ 60  90  70  90]
 [ 70  80  90 100]]

A^T A:
[[24700 26700]
 [26700 29400]]
```

#### 📝 sample17_matrix_multiply.R

```r
# データフレームから行列を作成
my_df <- data.frame(
  english = c(60, 90, 70, 90),
  math    = c(70, 80, 90, 100)
)
A <- as.matrix(my_df)

print("行列A:")
print(A)

# 転置行列
A_T <- t(A)
print("転置行列A^T:")
print(A_T)

# 行列の積を計算（%*%演算子を使用）
result <- A_T %*% A

print("A^T A:")
print(result)
```

**実行方法：**

```bash
$ Rscript sample17_matrix_multiply.R
```

**期待される出力：**

```
[1] "行列A:"
     english math
[1,]      60   70
[2,]      90   80
[3,]      70   90
[4,]      90  100
[1] "転置行列A^T:"
        [,1] [,2] [,3] [,4]
english   60   90   70   90
math      70   80   90  100
[1] "A^T A:"
        english  math
english   24700 26700
math      26700 29400
```

#### 🔍 行列の積の注意点

**演算子が違う：**
- **Python**: `@` 演算子（または `np.dot()`）
- **R**: `%*%` 演算子

**`*` は要素ごとの積：**
```python
# ❌ 行列の積ではない
A_T * A  # 各要素を掛け合わせる（サイズが合わないとエラー）

# ✅ 行列の積
A_T @ A  # 正しい行列の積
```

---

## 💡 GitHub Copilot活用ガイド（3.4.4 補足：行列）

### このセクションで学んだことをCopilotで実践

行列は機械学習やデータ分析で頻繁に使われます。データフレームから行列への変換、転置、行列の積など、基本操作を理解しておくことが重要です。Copilotを活用して、行列操作に慣れましょう。

---

### 🚀 使えるプロンプト例

#### プロンプト例1: データフレームから特定の列を行列化 [★★☆]

**Copilot Chatに入力**:
```
Pythonで、以下を実行してください：
1. 学生成績データフレーム（name, english, math, science）を作成
2. english, math, scienceの3列を行列に変換
3. 行列のサイズを表示
NumPyを使用してください。
```

**期待される動作**:
- データフレームの作成
- `.values` で行列に変換
- `.shape` でサイズ確認

**やってみよう**:
1. 新しいファイル `copilot_practice11.py` を作成
2. Copilotでコードを生成
3. 5人以上のデータで試す
4. 異なる列の組み合わせでも実験

---

#### プロンプト例2: 行列演算の練習 [★★★]

**Copilot Chatに入力**:
```
Rで、2つの行列を作成して以下の計算をしてください：
行列A: 3行2列、値は1から6
行列B: 2行4列、値は1から8
1. A と B の積（A %*% B）を計算
2. 結果の行列のサイズを確認
3. 結果を表示
```

**期待される動作**:
- `matrix()` で2つの行列を作成
- `%*%` で行列の積を計算
- サイズが3行4列になることを確認

**やってみよう**:
1. 新しいファイル `copilot_practice09.R` を作成
2. Copilotで行列演算のコードを生成
3. サイズが合わない行列の積を試してエラーを確認
4. 転置を使ってサイズを調整する方法も試す

---

#### プロンプト例3: 共分散行列の計算 [★★★]

**Copilot Chatに入力**:
```
Pythonで、学生成績データフレームから共分散行列を計算してください：
1. english, mathの2列を行列Aに変換
2. 各列の平均を引いて中心化
3. (A^T @ A) / (n-1) で共分散行列を計算（nは学生数）
4. 結果を表示
NumPyを使用してください。
```

**期待される動作**:
- データの中心化処理
- 転置と行列の積
- 共分散行列の計算式

**やってみよう**:
1. 新しいファイル `copilot_practice12.py` を作成
2. Copilotで共分散行列の計算コードを生成
3. `np.cov()` 関数の結果と比較
4. 相関係数行列も計算してみる

---

### 📚 Copilot活用のコツ

#### 1. **数式をコメントで説明**

行列の計算式をコメントで書くと、Copilotが適切なコードを提案してくれます。

```python
# 共分散行列を計算: Cov = (X^T @ X) / (n-1)
```

#### 2. **サイズの確認を習慣に**

行列操作では、サイズの不一致がよくあるエラーです。Copilotに確認コードも一緒に生成してもらいましょう。

```
「行列の積を計算する前に、サイズが適合するか確認するコードも含めてください」
```

#### 3. **データフレームと行列の相互変換パターンを学ぶ**

Copilotに様々な変換パターンを聞いてみましょう。
- 特定の列だけを行列化
- 行名・列名を保持した変換
- 条件に合う行だけを行列化

---

### ⚠️ 注意事項

#### **行列の積は可換ではない**
- $A \times B \neq B \times A$ （順序が重要）
- サイズの適合性を確認（A が m×n なら B は n×p である必要がある）

#### **演算子の違いに注意**
- Python: `@` が行列の積、`*` は要素ごとの積
- R: `%*%` が行列の積、`*` は要素ごとの積

#### **データ型の確認**
- NumPy配列とPandas DataFrameは異なる型
- 必要に応じて `.values` で変換

---

## 3.4.5 横型と縦型

データをデータフレームで表現する形式には、**横型**（wider）と**縦型**（longer）があります。縦型のデータフレームは**整然データ**（tidy data）ともいいます。

### 📊 横型と縦型の違い

#### 横型（wider）データ

1行に1件のインスタンスがあり、各行には観測値が1個以上あります。

**例：3日間の気温データ（横型）**

| day | min | max |
| :-- | :-: | :-: |
| 25 | 20 | 24 |
| 26 | 21 | 27 |
| 27 | 15 | 21 |

#### 縦型（longer）データ

1行に観測値が1個だけの形式です。6個の観測値を6行で表現します。

**例：3日間の気温データ（縦型）**

| day | name | value |
| :-- | :-- | :-- |
| 25 | min | 20 |
| 25 | max | 24 |
| 26 | min | 21 |
| 26 | max | 27 |
| 27 | min | 15 |
| 27 | max | 21 |

### 💡 どちらを使うべきか

**横型が適している場合：**
- データ入力時（Excelのような感覚）
- 人間が読みやすい形式
- Pythonでの可視化

**縦型が適している場合：**
- データ分析・統計処理
- Rでの可視化（ggplot2）
- データベースへの格納

---

### 3.4.5.1 横型から縦型への変換

#### 📝 sample18_wide_to_long.py

```python
# pandasライブラリを読み込む
import pandas as pd

# 横型のデータフレームを作成
my_wider = pd.DataFrame({
    'day': [25, 26, 27],
    'min': [20, 21, 15],
    'max': [24, 27, 21]
})

print("横型データ:")
print(my_wider)

# 縦型に変換
my_longer = my_wider.melt(id_vars='day',
                           var_name='type',
                           value_name='temp')

print("\n縦型データ:")
print(my_longer)
```

**実行方法：**

```bash
(class) $ python sample18_wide_to_long.py
```

**期待される出力：**

```
横型データ:
   day  min  max
0   25   20   24
1   26   21   27
2   27   15   21

縦型データ:
   day type  temp
0   25  min    20
1   26  min    21
2   27  min    15
3   25  max    24
4   26  max    27
5   27  max    21
```

#### 📝 sample18_wide_to_long.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# 横型のデータフレームを作成
my_wider <- data.frame(
  day = c(25, 26, 27),
  min = c(20, 21, 15),
  max = c(24, 27, 21)
)

print("横型データ:")
print(my_wider)

# 縦型に変換
my_longer <- my_wider %>%
  pivot_longer(cols = -day,
               names_to = "type",
               values_to = "temp")

print("縦型データ:")
print(my_longer)
```

**実行方法：**

```bash
$ Rscript sample18_wide_to_long.R
```

**期待される出力：**

```
[1] "横型データ:"
  day min max
1  25  20  24
2  26  21  27
3  27  15  21
[1] "縦型データ:"
# A tibble: 6 × 3
    day type   temp
  <dbl> <chr> <dbl>
1    25 min      20
2    25 max      24
3    26 min      21
4    26 max      27
5    27 min      15
6    27 max      21
```

---

### 3.4.5.2 縦型から横型への変換

#### 📝 sample19_long_to_wide.py

```python
# pandasライブラリを読み込む
import pandas as pd

# 縦型のデータフレームを作成
my_longer = pd.DataFrame({
    'day':  [25, 25, 26, 26, 27, 27],
    'type': ['min', 'max', 'min', 'max', 'min', 'max'],
    'temp': [20, 24, 21, 27, 15, 21]
})

print("縦型データ:")
print(my_longer)

# 横型に変換
my_wider = my_longer.pivot(
    index='day',
    columns='type',
    values='temp'
)

print("\n横型データ:")
print(my_wider)
```

**実行方法：**

```bash
(class) $ python sample19_long_to_wide.py
```

**期待される出力：**

```
縦型データ:
   day type  temp
0   25  min    20
1   25  max    24
2   26  min    21
3   26  max    27
4   27  min    15
5   27  max    21

横型データ:
type  max  min
day          
25     24   20
26     27   21
27     21   15
```

#### 📝 sample19_long_to_wide.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

# 縦型のデータフレームを作成
my_longer <- data.frame(
  day  = c(25, 25, 26, 26, 27, 27),
  type = c("min", "max", "min", "max", "min", "max"),
  temp = c(20, 24, 21, 27, 15, 21)
)

print("縦型データ:")
print(my_longer)

# 横型に変換
my_wider <- my_longer %>%
  pivot_wider(names_from = type,
              values_from = temp)

print("横型データ:")
print(my_wider)
```

**実行方法：**

```bash
$ Rscript sample19_long_to_wide.R
```

**期待される出力：**

```
[1] "縦型データ:"
  day type temp
1  25  min   20
2  25  max   24
3  26  min   21
4  26  max   27
5  27  min   15
6  27  max   21
[1] "横型データ:"
# A tibble: 3 × 3
    day   min   max
  <dbl> <dbl> <dbl>
1    25    20    24
2    26    21    27
3    27    15    21
```

---

### 🔍 コードの解説

**Python版：**
- `.melt()`: 横型→縦型への変換
  - `id_vars`: 固定する列
  - `var_name`: 変数名を格納する列名
  - `value_name`: 値を格納する列名
- `.pivot()`: 縦型→横型への変換
  - `index`: 行として使う列
  - `columns`: 列名として使う列
  - `values`: 値として使う列

**R版：**
- `pivot_longer()`: 横型→縦型への変換
  - `cols`: 変換する列（`-day` で day 以外すべて）
  - `names_to`: 変数名の列名
  - `values_to`: 値の列名
- `pivot_wider()`: 縦型→横型への変換
  - `names_from`: 列名にする列
  - `values_from`: 値にする列

---

## 💡 GitHub Copilot活用ガイド（3.4.5 横型と縦型）

### このセクションで学んだことをCopilotで実践

データ形式の変換は、可視化や分析の前に必ず行う重要な操作です。横型と縦型を自在に変換できるようになると、様々なツールやライブラリに対応できます。

---

### 🚀 使えるプロンプト例

#### プロンプト例1: 複数の測定値を縦型に変換 [★★☆]

**Copilot Chatに入力**:
```
Pythonで、以下のデータを縦型に変換してください：
店舗ごとの月別売上データ（shop, jan, feb, mar の列）
jan, feb, marを month と sales の2列に変換
pandasのmeltを使用してください。
```

**期待される動作**:
- 横型データの作成
- `.melt()` で縦型に変換
- 列名を適切に設定

**やってみよう**:
1. 新しいファイル `copilot_practice13.py` を作成
2. Copilotで変換コードを生成
3. 変換前後のデータを比較
4. 他の月（apr, may など）も追加して実験

---

#### プロンプト例2: 縦型データを横型に戻す [★★☆]

**Copilot Chatに入力**:
```
Rで、以下の縦型データを横型に戻してください：
列: student_id, subject, score
各学生が複数の科目（english, math, science）を受験
pivot_widerを使って、科目を列にしてください。
```

**期待される動作**:
- 縦型データの作成
- `pivot_wider()` で横型に変換
- 各科目が列になる

**やってみよう**:
1. 新しいファイル `copilot_practice10.R` を作成
2. 縦型データを作成（10人×3科目）
3. Copilotで横型への変換コードを生成
4. 科目を増やして（4科目、5科目）実験

---

#### プロンプト例3: 実用的な変換パイプライン [★★★]

**Copilot Chatに入力**:
```
Pythonで、以下の処理をしてください：
1. 横型データ（地域、1月〜12月の売上）を作成
2. 縦型に変換（地域、月、売上）
3. 月ごとの平均売上を計算
4. 再び横型に戻して、地域×月の表にする
```

**期待される動作**:
- データ作成、縦型変換、集計、横型変換の一連の流れ
- `melt()`, `groupby()`, `pivot()` の組み合わせ

**やってみよう**:
1. 新しいファイル `copilot_practice14.py` を作成
2. Copilotで一連の処理コードを生成
3. 各ステップの結果を確認
4. 集計方法を変えて（合計、最大値など）実験

---

### 📚 Copilot活用のコツ

#### 1. **変換の目的を明確に伝える**

「可視化のため」「分析のため」など、目的を伝えると適切な形式を提案してくれます。

```
「ggplot2で可視化するために、このデータを縦型に変換してください」
```

#### 2. **列名の命名規則を指定**

変換後の列名を具体的に指定すると、わかりやすいコードが生成されます。

```
「変換後の列名は 'category' と 'amount' にしてください」
```

---

### ⚠️ 注意事項

#### **インデックスの扱い**
- Pythonの `pivot()` は index を設定する
- 必要に応じて `.reset_index()` で通常の列に戻す

#### **重複データの処理**
- 同じキーで複数の値がある場合はエラー
- 集計関数を使うか、`pivot_table()` を使用

---

### 🎓 推奨される学習の流れ

```
1. シンプルな横型→縦型変換
   ↓
2. 縦型→横型変換
   ↓
3. 複数列の変換
   ↓
4. 変換+集計の組み合わせ
   ↓
5. 実データで可視化に活用
```

**データ形式の変換をマスターすれば、どんな形式のデータでも扱えるようになります！**

---

## 3.4.6 統合演習

ここまで学んだデータフレームの操作を総合的に活用する演習問題に挑戦しましょう。

### 📝 演習課題：学生成績データの総合分析

以下の要件を満たすプログラムを作成してください。

#### 📋 課題の要件

**1. データの準備**
- 10人分の学生データを作成
- 列：`student_id`（1〜10）、`name`、`english`、`math`、`science`、`gender`

**2. データ分析**

以下の分析を順番に行い、結果を表示してください：

1. **基本統計**
   - 各科目の平均点を計算して表示
   - 全体の平均点が最も高い科目を表示

2. **データの追加**
   - 各学生の3科目の合計点（`total`）を列として追加
   - 合計点の平均（`average`）を列として追加

3. **条件検索**
   - 合計点が240点以上の優秀な学生を抽出
   - 英語が80点以上かつ数学が70点以上の学生を抽出

4. **ランキング**
   - 合計点の降順に並べ替え
   - 上位3名の `name`、`total`、`average` を表示

5. **データの変形**
   - `student_id`、`name`、3科目の点数を縦型データに変換
   - 科目名（`subject`）と点数（`score`）の2列にする

6. **結果の保存**
   - 上位3名のデータを新しいデータフレームとして保存
   - その内容を表示

#### 💡 ヒント

- データフレームの作成には `pd.DataFrame()` または `data.frame()` を使用
- 列の追加には `.assign()` や `mutate()` を使用
- 条件検索には条件式や `filter()` を使用
- 並べ替えには `.sort_values()` や `arrange()` を使用
- 縦型変換には `.melt()` や `pivot_longer()` を使用

---

### 📝 解答例（基本版）

#### exercise01_student_analysis.py

```python
# pandasライブラリを読み込む
import pandas as pd

print("=" * 50)
print("学生成績データの総合分析")
print("=" * 50)

# 1. データの準備
students = pd.DataFrame({
    'student_id': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
    'name': ['Alice', 'Bob', 'Charlie', 'David', 'Emma', 
             'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'],
    'english': [85, 92, 78, 88, 95, 72, 90, 83, 88, 91],
    'math': [90, 85, 88, 92, 89, 78, 87, 90, 85, 88],
    'science': [88, 90, 85, 87, 92, 80, 89, 86, 90, 87],
    'gender': ['f', 'm', 'm', 'm', 'f', 'm', 'f', 'm', 'f', 'm']
})

print("\n【元のデータ】")
print(students)

# 2. 基本統計
print("\n【基本統計】")
print("各科目の平均点:")
print(f"英語: {students['english'].mean():.1f}点")
print(f"数学: {students['math'].mean():.1f}点")
print(f"理科: {students['science'].mean():.1f}点")

avg_scores = {
    'english': students['english'].mean(),
    'math': students['math'].mean(),
    'science': students['science'].mean()
}
best_subject = max(avg_scores, key=avg_scores.get)
print(f"\n平均点が最も高い科目: {best_subject}（{avg_scores[best_subject]:.1f}点）")

# 3. データの追加（合計点と平均点）
students['total'] = students['english'] + students['math'] + students['science']
students['average'] = students['total'] / 3

print("\n【合計点・平均点を追加】")
print(students[['name', 'total', 'average']])

# 4. 条件検索
print("\n【条件検索】")
high_achievers = students[students['total'] >= 240]
print("\n合計点240点以上の学生:")
print(high_achievers[['name', 'total']])

eng_math_strong = students[(students['english'] >= 80) & (students['math'] >= 70)]
print("\n英語80点以上かつ数学70点以上の学生:")
print(eng_math_strong[['name', 'english', 'math']])

# 5. ランキング
print("\n【ランキング】")
ranked = students.sort_values('total', ascending=False)
top3 = ranked.head(3)
print("\n合計点トップ3:")
print(top3[['name', 'total', 'average']])

# 6. データの変形（縦型）
print("\n【データの縦型変換】")
long_data = students[['student_id', 'name', 'english', 'math', 'science']].melt(
    id_vars=['student_id', 'name'],
    var_name='subject',
    value_name='score'
)
print(long_data.head(10))

# 7. 結果の保存
print("\n【トップ3のデータを保存】")
top3_data = top3[['name', 'english', 'math', 'science', 'total', 'average']].copy()
print(top3_data)

print("\n" + "=" * 50)
print("分析完了！")
print("=" * 50)
```

**実行方法：**

```bash
(class) $ python exercise01_student_analysis.py
```

---

#### exercise01_student_analysis.R

```r
# tidyverseライブラリを読み込む
library(tidyverse)

cat(strrep("=", 50), "\n")
cat("学生成績データの総合分析\n")
cat(strrep("=", 50), "\n\n")

# 1. データの準備
students <- data.frame(
  student_id = 1:10,
  name = c('Alice', 'Bob', 'Charlie', 'David', 'Emma', 
           'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'),
  english = c(85, 92, 78, 88, 95, 72, 90, 83, 88, 91),
  math = c(90, 85, 88, 92, 89, 78, 87, 90, 85, 88),
  science = c(88, 90, 85, 87, 92, 80, 89, 86, 90, 87),
  gender = c('f', 'm', 'm', 'm', 'f', 'm', 'f', 'm', 'f', 'm')
)

cat("【元のデータ】\n")
print(students)

# 2. 基本統計
cat("\n【基本統計】\n")
cat("各科目の平均点:\n")
cat(sprintf("英語: %.1f点\n", mean(students$english)))
cat(sprintf("数学: %.1f点\n", mean(students$math)))
cat(sprintf("理科: %.1f点\n", mean(students$science)))

avg_scores <- c(
  english = mean(students$english),
  math = mean(students$math),
  science = mean(students$science)
)
best_subject <- names(which.max(avg_scores))
cat(sprintf("\n平均点が最も高い科目: %s（%.1f点）\n", 
            best_subject, max(avg_scores)))

# 3. データの追加（合計点と平均点）
students <- students %>%
  mutate(
    total = english + math + science,
    average = total / 3
  )

cat("\n【合計点・平均点を追加】\n")
print(students %>% select(name, total, average))

# 4. 条件検索
cat("\n【条件検索】\n")
high_achievers <- students %>% filter(total >= 240)
cat("\n合計点240点以上の学生:\n")
print(high_achievers %>% select(name, total))

eng_math_strong <- students %>% 
  filter(english >= 80 & math >= 70)
cat("\n英語80点以上かつ数学70点以上の学生:\n")
print(eng_math_strong %>% select(name, english, math))

# 5. ランキング
cat("\n【ランキング】\n")
ranked <- students %>% arrange(-total)
top3 <- ranked %>% head(3)
cat("\n合計点トップ3:\n")
print(top3 %>% select(name, total, average))

# 6. データの変形（縦型）
cat("\n【データの縦型変換】\n")
long_data <- students %>%
  select(student_id, name, english, math, science) %>%
  pivot_longer(
    cols = c(english, math, science),
    names_to = "subject",
    values_to = "score"
  )
print(long_data %>% head(10))

# 7. 結果の保存
cat("\n【トップ3のデータを保存】\n")
top3_data <- top3 %>% 
  select(name, english, math, science, total, average)
print(top3_data)

cat("\n", strrep("=", 50), "\n", sep="")
cat("分析完了！\n")
cat(strrep("=", 50), "\n")
```

**実行方法：**

```bash
$ Rscript exercise01_student_analysis.R
```

---

### 📚 参考: より実践的な書き方（発展版）

より実務的なコードの書き方を学びたい方のために、関数化とエラーハンドリングを含む発展版を紹介します。

**現時点では基本版で十分です。** 意欲的な学生の方は、以下を参考にしてください。

#### exercise01_advanced.py（発展版）

```python
import pandas as pd
from typing import Dict, Tuple

def load_student_data() -> pd.DataFrame:
    """学生データを作成する"""
    return pd.DataFrame({
        'student_id': range(1, 11),
        'name': ['Alice', 'Bob', 'Charlie', 'David', 'Emma', 
                 'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'],
        'english': [85, 92, 78, 88, 95, 72, 90, 83, 88, 91],
        'math': [90, 85, 88, 92, 89, 78, 87, 90, 85, 88],
        'science': [88, 90, 85, 87, 92, 80, 89, 86, 90, 87],
        'gender': ['f', 'm', 'm', 'm', 'f', 'm', 'f', 'm', 'f', 'm']
    })

def calculate_statistics(df: pd.DataFrame) -> Dict[str, float]:
    """各科目の平均点を計算"""
    return {
        'english': df['english'].mean(),
        'math': df['math'].mean(),
        'science': df['science'].mean()
    }

def add_total_and_average(df: pd.DataFrame) -> pd.DataFrame:
    """合計点と平均点を追加"""
    return df.assign(
        total=df['english'] + df['math'] + df['science'],
        average=lambda x: x['total'] / 3
    )

def get_top_students(df: pd.DataFrame, n: int = 3) -> pd.DataFrame:
    """上位n名を取得"""
    return df.sort_values('total', ascending=False).head(n)

def main():
    """メイン処理"""
    print("=" * 50)
    print("学生成績データの総合分析（発展版）")
    print("=" * 50)
    
    # データ読み込み
    students = load_student_data()
    
    # 統計情報
    stats = calculate_statistics(students)
    print("\n【基本統計】")
    for subject, avg in stats.items():
        print(f"{subject}: {avg:.1f}点")
    
    # 合計・平均追加
    students = add_total_and_average(students)
    
    # トップ3取得
    top3 = get_top_students(students, 3)
    print("\n【トップ3】")
    print(top3[['name', 'total', 'average']])
    
    print("\n" + "=" * 50)

if __name__ == "__main__":
    main()
```

---

### 💡 発展版のポイント

1. **関数化**: 処理ごとに関数に分割
2. **型ヒント**: 引数と戻り値の型を明示
3. **main関数**: エントリーポイントを明確化
4. **再利用性**: 関数を組み合わせて様々な分析が可能

---

## 3.4.7 学習チェックリスト

本節で学んだ内容を確認しましょう。以下のチェックリストを使って、理解度を確認してください。

### A. 環境構築と基本操作

- [ ] tidyverse（R）またはpandas（Python）をインポートできる
- [ ] データフレームの基本概念を理解している
- [ ] サンプル、インスタンス、変数、観測値の用語を説明できる
- [ ] サンプルサイズの意味を理解している
- [ ] 「サンプル数」「母数」という誤用を避けられる

### B. データフレームの作成

- [ ] 列ごとにデータを記述してデータフレームを作成できる
- [ ] 行ごとにデータを記述してデータフレームを作成できる
- [ ] データフレームのサイズ（行数・列数）を確認できる
- [ ] すべての組合せを持つデータフレームを作成できる
- [ ] 列名を取得・変更できる
- [ ] 行名を取得・変更できる
- [ ] PythonとRでインデックスの開始位置が異なることを理解している

### C. データの追加

- [ ] データフレームに新しい行を追加できる
- [ ] データフレームに新しい列を追加できる
- [ ] 新しいデータフレームを作る方法と元を更新する方法を使い分けられる
- [ ] 列の追加時にデータの長さを合わせる必要があることを理解している
- [ ] Pythonでのコピー（.copy()）の重要性を理解している
- [ ] 行追加を繰り返すとパフォーマンスが悪化することを知っている

### D. データの取り出し

- [ ] 特定の観測値（1つの値）を取り出せる
- [ ] 1列を1次元データとして取り出せる
- [ ] 複数列をデータフレームとして取り出せる
- [ ] 複数行をデータフレームとして取り出せる
- [ ] 列名での指定と列番号での指定を使い分けられる
- [ ] 単一条件でデータを検索できる
- [ ] 複数条件（AND/OR）でデータを検索できる
- [ ] PythonでのAND（&）とOR（|）の使い方を理解している
- [ ] 条件式で括弧が必要な理由を理解している
- [ ] データフレームを昇順・降順に並べ替えられる
- [ ] 複数列で並べ替えができる
- [ ] 取り出し操作が元のデータを変更しないことを理解している

### E. 行列操作

- [ ] 1次元データから行列を作成できる
- [ ] データフレームを行列に変換できる
- [ ] 行列をデータフレームに変換できる
- [ ] 行列の転置を計算できる
- [ ] 行列の積を計算できる
- [ ] Pythonでの @、Rでの %*% を使い分けられる
- [ ] * は要素ごとの積であることを理解している
- [ ] 行列のサイズの適合性を確認できる

### F. データ形式の変換

- [ ] 横型（wider）と縦型（longer）の違いを説明できる
- [ ] 整然データ（tidy data）の概念を理解している
- [ ] 横型から縦型にデータを変換できる
- [ ] 縦型から横型にデータを変換できる
- [ ] Pythonでの.melt()と.pivot()の使い方を理解している
- [ ] Rでのpivot_longer()とpivot_wider()の使い方を理解している
- [ ] どちらの形式が可視化に適しているか理解している（Rは縦型、Pythonは横型）

### G. AI協働スキル

- [ ] GitHub Copilotの基本的な使い方を理解している
- [ ] データフレーム操作で効果的なプロンプトを書ける
- [ ] 生成されたコードを理解してから使用している
- [ ] Copilotが生成したコードを検証する習慣がある
- [ ] エラーメッセージをCopilotに伝えて解決策を得られる
- [ ] PythonとRの両方のコードをCopilotで生成できる
- [ ] コメントを使ってCopilotにコード生成を依頼できる
- [ ] AI協働と丸投げの違いを理解している

### H. 概念理解

- [ ] データフレームが表形式のデータ構造であることを理解している
- [ ] データフレームとExcelの表の類似点と相違点を説明できる
- [ ] なぜデータフレームを使うのか説明できる
- [ ] 機械学習での行列の役割を理解している
- [ ] データ分析の流れ（読込→加工→分析→可視化）を理解している
- [ ] データクリーニングの重要性を理解している

### I. 実践スキル

- [ ] データフレームの基本操作を組み合わせて分析できる
- [ ] 条件検索と並べ替えを組み合わせたランキング作成ができる
- [ ] 計算列を追加してデータを拡張できる
- [ ] データ形式を変換して可視化の準備ができる
- [ ] 複数のデータフレームを結合できる
- [ ] エラーが出たときに原因を特定して修正できる
- [ ] ドキュメントを読んで新しい関数を理解できる

### J. 課題完遂

- [ ] 統合演習の課題を完了した
- [ ] プログラムが正常に実行されることを確認した
- [ ] 出力結果が期待通りであることを確認した
- [ ] 基本版のコードを理解している
- [ ] （オプション）発展版のコードにも挑戦した

---

## 🎯 達成度評価

チェックした項目数に応じて、あなたの達成度を確認しましょう。

| チェック数 | 達成度 | コメント |
|:---:|:---|:---|
| 70-75 | 🌟 完璧！ | データフレーム操作を完全にマスターしています！次の章へ進みましょう。 |
| 60-69 | 🎉 優秀 | ほとんどの操作を理解しています。不安な部分を復習しましょう。 |
| 50-59 | 👍 良好 | 基本は押さえています。応用的な部分を練習しましょう。 |
| 40-49 | 📖 要復習 | 基礎をもう一度確認しましょう。サンプルコードを実行し直してください。 |
| 0-39 | 💪 再学習 | 焦らず、一つずつ理解を深めていきましょう。質問があれば遠慮なく。 |

---

## 📝 復習のポイント

チェックできなかった項目がある場合は、以下を参考に復習しましょう。

### データフレームの基本が不安な方

1. 3.4.0〜3.4.1を再読
2. sample01〜sample05を実行
3. 自分でデータフレームを作成する練習

### データの追加・取り出しが不安な方

1. 3.4.2〜3.4.3を再読  
2. sample06〜sample13を実行
3. 様々な条件で検索・並べ替えを実験

### 行列・データ変形が不安な方

1. 3.4.4〜3.4.5を再読
2. sample14〜sample19を実行
3. 自分でデータを変形してみる

### 統合的な理解が不安な方

1. 統合演習を再挑戦
2. GitHub Copilotを活用
3. 小規模な分析課題を自分で設定して解く

---

## 🚀 次のステップ

データフレーム操作をマスターしたあなたは、以下に進む準備ができています。

1. **データの可視化**（第4章）
   - データフレームを使ったグラフ作成
   - 横型・縦型データの使い分け

2. **統計分析**（第8章以降）
   - データフレームを使った統計処理
   - 機械学習への応用

3. **実データ分析**
   - CSVファイルの読み込み
   - データクリーニング
   - 探索的データ分析（EDA）

---

## 🎓 おわりに

**おめでとうございます！** データフレームの基本をマスターしました。

データフレームは、データサイエンスの最も重要なデータ構造です。この章で学んだスキルは、今後のすべてのデータ分析の基礎となります。

- ✅ データの作成・追加・取り出しができる
- ✅ 条件検索と並べ替えができる
- ✅ 行列操作の基本を理解している
- ✅ データ形式を変換できる
- ✅ AI（Copilot）と協働してコードを書ける

これらのスキルを使って、実際のデータ分析に挑戦してみましょう！

---

### 💬 質問・フィードバック

理解が難しかった部分や、もっと知りたい内容があれば、遠慮なく質問してください。データフレーム操作は練習あるのみです。たくさんコードを書いて、エラーを経験して、実践的なスキルを身につけていきましょう！

**Happy Data Science! 🎉**

